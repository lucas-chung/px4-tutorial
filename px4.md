# px4-tutorial

本人在学习制作无人机编队的过程中遇到的种种问题将会再此仓库中记录下来。

本教程将结合px4文档进行教学，但是新手直接上文档往往会看不懂。

### 1.简介

pixhawk是ETH大学的一个开源硬件项目，而PX4则是飞控的名称，是一个软件项目，px4一开始是为pixhawk而设计的（现在在一些其他飞控也可以运行），因此很多人也不做区分。而我们此次使用pixhawk叫做pixhawk2.4.8，是国内厂商山寨pixhawk FMUv2的，不同的FMU版本指的是不同的硬件设计和功能，其中较高的FMU编号表示飞控板较新，例如FMUv1、FMUv2、FMUv3等。

至于为什么选择pixhawk，摘自网上一位博主的话，如果大疆飞控是无人机界的苹果，那么pixhawk就是安卓

### 2.QGC地面站

[Releases · mavlink/qgroundcontrol (github.com)](https://github.com/mavlink/qgroundcontrol/releases)

QGC地面站是配合px4一起使用的，直接win、macos、linux等操作系统，同时也是开源的。

此次教学使用的版本是：

### 3.各项配置简介

#### 3.1 遥控器

#### 3.2 飞行模式

飞行模式我这里只介绍多旋翼（四旋翼）

px4可分为手动模式和自动模式，手动模式一般就是通过遥控器控制无人机运动，适合一些玩穿越机的飞手，对于无人机飞行掌控技术要求很高，记住，是很高！不然非常容易炸鸡或者飞机直接飞不见了，建议新手先不要从这方面入手。自动模式就是不需要用户控制遥控器摇杆控制无人机飞行。

自动模式

1.orbit mode（环绕模式）

可以使得无人机绕着一个中心绕圈飞行

2.hold mode

使多旋翼飞行器停止并悬停在其当前位置和高度（保持位置免受风和其他力量的影响）

3.return mode（返航模式）

默认情况下，多轴飞行器将简单地上升到安全高度，飞到其初始位置，然后着陆。

4.mission mode（任务模式）

在QGC可以定义航点，然后无人机会按照航点一个一个的运动，用专业术语讲就是使飞行器执行已上传到飞行控制器的预定义自主任务（飞行计划）

5.takeoff mode（起飞）

起飞模式使多旋翼飞行器垂直爬升至高度并悬停在原位。起飞高度可以通过MIS_TAKEOFF_ALT参数设置

6.land mode（着陆）

7.follow me mode（跟随模式）

顾名思义，就是会跟着你运动，但是需要你一直提供位置信息，位置定点可能来自运行*QGroundControl*的Android手机/平板或者MAVSDK应用程序。

8.offboard mode

非常重要的一个模式，后面会单独讲

### 4.校准

这一步是非常容易出问题的一步，对于自己购买pixhawk进行烧录以及校准的同学，主要出现在遥控器校准和电调以及电源校准的问题上。



电调校准：在设置好电池的参数后，要电机最下面的校准进行电调校准，然后提示我必须拔掉电源，只使用USB供电，但是我明明就是只用usb供电的，非常奇怪。原因是必须插上电流计，然后电流计的一端必须和电源断开，才能开始校准

PWM输出信号的调整！！（非常重要）：

可能设置的PWM信号值太小了，电机不转，导致一股烧焦味。电机转速可以通过调整PWM_MAIN_MIN和PWM_MAIN_MAX参数设置，同时还有PWM_MAIN_MIN1、2、3，这个是根据用户自己自定义而设置的参数，如果不修改，则默认都为PWM_MAIN_MIN的值。我一开始设置为250μs，可能是转速太小了，导致电机无法转动，电能转化为热能，一股烧焦味。

电机：提示MAV_CMD(209)命令被拒绝，其实是忘记按安全开关了！

遥控器试飞：继续不要装螺旋桨，将通道5拔下解锁，然后记住，遥控器油门必须打到最低！！！

takeoff：必须要有位置模块才能切换

### 5.自己在烧录程序过程中遇到的问题

下载了QGC 4.2地面站后，插上USB打算下载固件，前面也说过，pixhawk2.4.8其实就相当于pixhawk FMUv2，所以插上USB后会显示检测到设备pixhawk FMUv2，此时按照教程准备下载，固件，现在是2023/12/28，如果点开下载固件，会显示目前官网最新的版本stable release v1.14.0版本（估计就是显示最新的，因为我下过3.5的地面站，依然会提示你安装v1.14.0版本）。下完之后，飞控立马闪红灯，就算不懂飞机的人估计也知道是错误了，第一次更新的时候我以为是因为上次炸鸡把飞控摔坏了，什么引脚脱落之类的，然后探索一番，发现应该是bootloader的原因，参考了csdn的一篇文章，他也遇到和我一样的原因，但是更新bootloader非常麻烦，不过我并不需要1.14.0的飞控，我觉得1.13.1就够用了，所以还是烧录回1.13.1

探索自此，我先来讲一下板子的构造PX4IO是协处理器，PX4FMU是指主处理器，我们也可以通过指示灯看出问题。根据官网的教程，我们后面也不会安装GPS，所以蓝灯常亮或者蓝灯闪烁，分别代表飞控已经解锁（armed的意思是解锁，反正我经常吧disarmed和armed弄混）以及上锁但已准备好。黄灯表示电池电量低，不过也算正常，而红灯就是发生错误，这时候是解锁都不行。紫灯暂时还没遇到过，官方解释是每当飞行器在飞行过程中遇到问题时，例如失去手动控制、电池电量严重不足或内部错误，此模式就会激活。在故障保护模式时，飞行器将试图返回起飞位置，或者降落在当前位置。



### 6.仿真

预备知识：ros、gazebo

主要的三个文件：

mavros_posix_sitl.launch、posix_sitl.launch、px4.launch

其中前两个文件有关联，mavros_posix_sitl.launch文件先启动gazebo仿真器，然后启动sitl（指的是px4在计算机中模拟运行，gazebo会将传感器数据传给sitl，然后sitl将电机数据传给仿真器从而运动）

px4.launch是单独运行sitl。









addition：A 紧急返航

